<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarÄ±nca - Personel Performans Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="karinca-logo.svg">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS CDN for Excel reading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Auth System -->
    <script src="js/firebaseAuth.js"></script>
    
    <!-- Utility Modules -->
    <script src="js/utils.js"></script>
    <script src="js/debugHelper.js"></script>
    
    <!-- Data Modules -->
    <script src="js/excelParser.js"></script>
    <script src="js/dataProcessor.js"></script>
    <script src="js/dataFetcher.js"></script>
    <script src="js/dateSelector.js"></script>
    
    <!-- Chart Module -->
    <script src="js/chartManager.js"></script>
    
    <!-- Main Application -->
    <script src="js/main.js"></script>

</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login-screen">
        <div class="login-wrapper">
            <div class="login-card-modern">
                <div class="login-header-modern">
                    <div class="logo-circle">
                        <img src="karinca-logo.svg" alt="KarÄ±nca Logo" class="logo-img">
                    </div>
                    <h1>KarÄ±nca Logistics</h1>
                    <p>Performans Dashboard</p>
                    <div class="welcome-text">HoÅŸ Geldiniz</div>
                </div>
                
                <form class="login-form-modern" onsubmit="event.preventDefault(); performLogin();">
                    <div class="input-wrapper">
                        <div class="input-icon">ğŸ‘¤</div>
                        <input 
                            type="email" 
                            id="login-email-input" 
                            class="input-modern" 
                            placeholder="Email"
                            autocomplete="email"
                            required
                        />
                    </div>
                    
                    <div class="input-wrapper">
                        <div class="input-icon">ğŸ”’</div>
                        <input 
                            type="password" 
                            id="login-password-input" 
                            class="input-modern" 
                            placeholder="Åifre"
                            autocomplete="current-password"
                            required
                        />
                    </div>
                    
                    <button type="submit" class="btn-modern">
                        GiriÅŸ Yap
                    </button>
                </form>
                
                <div class="login-footer-modern">
                    <p>ğŸ” Sadece yetkili kullanÄ±cÄ±lar eriÅŸebilir</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header" id="main-header" style="display: none;">
        <div class="header-content">
            <h1 class="header-title">
                <img src="karinca-logo.svg" alt="KarÄ±nca Logo" class="header-logo">
                Personel Performans Dashboard
            </h1>
            <div class="header-actions">
                <button id="refresh-btn" class="btn btn-primary" onclick="refreshData()" title="Verileri Yenile">
                    <span class="btn-icon">ğŸ”„</span>
                    Yenile
                </button>
                <button id="debug-btn" class="btn btn-secondary" onclick="toggleDebug()">
                    <span class="btn-icon">ğŸ”</span>
                    Debug
                </button>
                <div class="settings-container">
                    <button id="settings-btn" class="btn btn-settings" onclick="toggleSettings()" title="Ayarlar">
                        <span class="settings-icon">âš™ï¸</span>
                    </button>
                    <div id="settings-menu" class="dropdown-menu">
                        <div class="menu-section">
                            <div class="menu-section-title">ğŸ¨ Tema</div>
                            <div class="menu-item" onclick="setTheme('light')">
                                <span class="menu-item-icon">â˜€ï¸</span>
                                <span class="menu-item-text">AydÄ±nlÄ±k</span>
                                <span class="theme-indicator" id="light-indicator"></span>
                            </div>
                            <div class="menu-item" onclick="setTheme('dark')">
                                <span class="menu-item-icon">ğŸŒ™</span>
                                <span class="menu-item-text">KaranlÄ±k</span>
                                <span class="theme-indicator" id="dark-indicator"></span>
                            </div>
                            <div class="menu-item" onclick="setTheme('auto')">
                                <span class="menu-item-icon">ğŸ”„</span>
                                <span class="menu-item-text">Otomatik</span>
                                <span class="theme-indicator" id="auto-indicator"></span>
                            </div>
                        </div>
                        <div class="menu-section" id="auth-section">
                            <div class="menu-section-title">ğŸ” Yetkilendirme</div>
                            <div class="menu-item" onclick="showAdminPanel()" id="admin-menu-item" style="display: none;">
                                <span class="menu-item-icon">ğŸ‘‘</span>
                                <span class="menu-item-text">Yetki Paneli</span>
                            </div>
                            <div class="menu-item" onclick="showPasswordManagement()" id="password-menu-item">
                                <span class="menu-item-icon">ğŸ”‘</span>
                                <span class="menu-item-text">Åifre YÃ¶netimi</span>
                            </div>
                            <div class="menu-item" onclick="showUserInfo()" id="user-info-item">
                                <span class="menu-item-icon">ğŸ‘¤</span>
                                <span class="menu-item-text">KullanÄ±cÄ± Bilgisi</span>
                            </div>
                            <div class="menu-item" onclick="logout()" id="logout-menu-item">
                                <span class="menu-item-icon">ğŸšª</span>
                                <span class="menu-item-text">Ã‡Ä±kÄ±ÅŸ Yap</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="menu-container">
                    <button id="menu-btn" class="btn btn-menu" onclick="toggleMenu()" title="MenÃ¼">
                        <span class="menu-icon">
                            <span class="menu-line"></span>
                            <span class="menu-line"></span>
                            <span class="menu-line"></span>
                        </span>
                    </button>
                    <div id="dropdown-menu" class="dropdown-menu">
                        <div class="menu-item" onclick="selectFileCurrentTab()">
                            <span class="menu-item-icon">ğŸ“‚</span>
                            <span class="menu-item-text">Dosya AÃ§</span>
                        </div>
                        <div class="menu-divider"></div>
                        <div class="menu-item" onclick="openNewTab()">
                            <span class="menu-item-icon">ğŸ“„</span>
                            <span class="menu-item-text">Yeni Dosya SeÃ§</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Container -->
    <main class="dashboard" id="main-dashboard" style="display: none;">
        <!-- Upload Section -->
        <section class="upload-section" id="upload-section">
            <div class="upload-container">
                <!-- GitHub URL AyarlarÄ± -->
                <div class="github-settings-card">
                    <div class="settings-header">
                        <h3>ğŸ”— GitHub'dan Otomatik Veri Ã‡ekme</h3>
                        <button class="btn btn-sm" onclick="toggleGitHubSettings()">
                            <span id="github-toggle-icon">â–¼</span> Ayarlar
                        </button>
                    </div>
                    
                    <div class="github-settings-content" id="github-settings-content" style="display: none;">
                        <div class="input-group">
                            <label for="github-url-input">GitHub Raw URL:</label>
                            <input 
                                type="url" 
                                id="github-url-input" 
                                class="input-modern" 
                                placeholder="https://raw.githubusercontent.com/user/repo/main/data.xlsx"
                            />
                            <small class="input-hint">
                                ğŸ’¡ Excel dosyanÄ±zÄ± GitHub'a yÃ¼kleyin ve "Raw" linkini buraya yapÄ±ÅŸtÄ±rÄ±n
                            </small>
                        </div>
                        
                        <div class="settings-row">
                            <div class="checkbox-group">
                                <input type="checkbox" id="auto-refresh-checkbox" />
                                <label for="auto-refresh-checkbox">Otomatik yenileme</label>
                            </div>
                            
                            <div class="input-group-inline">
                                <label for="refresh-interval">Yenileme sÄ±klÄ±ÄŸÄ±:</label>
                                <select id="refresh-interval" class="select-modern">
                                    <option value="1800000">30 dakika</option>
                                    <option value="3600000" selected>1 saat</option>
                                    <option value="7200000">2 saat</option>
                                    <option value="14400000">4 saat</option>
                                    <option value="28800000">8 saat</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="settings-actions">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">
                                ğŸ’¾ AyarlarÄ± Kaydet
                            </button>
                            <button class="btn btn-success" onclick="loadFromGitHub()">
                                ğŸ“¥ Åimdi Ã‡ek
                            </button>
                        </div>
                        
                        <div class="last-fetch-info" id="last-fetch-info" style="display: none;">
                            <small>Son Ã§ekme: <span id="last-fetch-time">-</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Manuel Dosya YÃ¼kleme -->
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>Manuel Dosya YÃ¼kleme</h3>
                    <p>Excel dosyasÄ±nÄ± sÃ¼rÃ¼kleyip bÄ±rakÄ±n veya seÃ§in</p>
                    <div class="upload-hint">
                        <small>ğŸ’¡ GitHub ayarÄ± yaparsanÄ±z otomatik Ã§ekilir</small>
                    </div>
                    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                        Dosya SeÃ§
                    </button>
                </div>
                
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <p class="progress-text" id="progress-text">Dosya iÅŸleniyor...</p>
                </div>
            </div>
        </section>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboard-content" style="display: none;">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="header-info">
                    <button class="info-btn" onclick="showPerformanceInfo()" title="Performans Hesaplama Bilgisi">
                        <span class="info-icon">â„¹ï¸</span>
                        <span class="info-text">Performans Hesaplama</span>
                    </button>
                    <button class="info-btn" onclick="toggleDateSelector()" title="Tarih SeÃ§ici">
                        <span class="info-icon">ğŸ“…</span>
                        <span class="info-text">Tarih SeÃ§ici</span>
                    </button>
                </div>
                <div class="header-content-center">
                    <h1>Performans Dashboard</h1>
                    <p class="dashboard-subtitle">KPI kartlarÄ±na tÄ±klayarak detaylÄ± bilgileri gÃ¶rÃ¼ntÃ¼leyebilirsiniz</p>
                </div>
            </div>
            
            <!-- Tarih SeÃ§ici Container -->
            <div class="date-selector-wrapper" id="date-selector-wrapper" style="display: none;">
                <div id="date-selector-container"></div>
            </div>

            <!-- KPI Cards -->
            <section class="kpi-section">
                <div class="kpi-cards">
                    <div class="kpi-card clickable" onclick="showPersonnelList()">
                        <div class="kpi-icon">ğŸ‘¥</div>
                        <div class="kpi-content">
                            <h3>Toplam Personel</h3>
                            <span class="kpi-value" id="total-personnel">0</span>
                        </div>
                        <div class="kpi-arrow">â†’</div>
                    </div>
                    <div class="kpi-card clickable" onclick="showQuantityDetails()">
                        <div class="kpi-icon">
                            <img src="karinca-logo.svg" alt="KarÄ±nca Logo" style="width: 2.8rem; height: 2.8rem;">
                        </div>
                        <div class="kpi-content">
                            <h3>Toplam Miktar</h3>
                            <span class="kpi-value" id="total-quantity">0</span>
                        </div>
                        <div class="kpi-arrow">â†’</div>
                    </div>
                    <div class="kpi-card clickable" onclick="showWarehouseDetails()">
                        <div class="kpi-icon">ğŸ“‹</div>
                        <div class="kpi-content">
                            <h3>Aktif Proje</h3>
                            <span class="kpi-value" id="active-warehouses">0</span>
                        </div>
                        <div class="kpi-arrow">â†’</div>
                    </div>
                    <div class="kpi-card clickable" onclick="showTransactionDetails()">
                        <div class="kpi-icon">ğŸ“¦</div>
                        <div class="kpi-content">
                            <h3>Toplam Ä°ÅŸlem</h3>
                            <span class="kpi-value" id="total-transactions">0</span>
                        </div>
                        <div class="kpi-arrow">â†’</div>
                    </div>
                    <div class="kpi-card clickable" onclick="showWorkingHours()">
                        <div class="kpi-icon">â°</div>
                        <div class="kpi-content">
                            <h3>Ã‡alÄ±ÅŸma Saatleri</h3>
                            <span class="kpi-value" id="working-hours">0h</span>
                        </div>
                        <div class="kpi-arrow">â†’</div>
                    </div>
                </div>
            </section>


        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // Global deÄŸiÅŸkenler
        let appData = null;
        let shiftData = null;
        let currentFileName = null;
        let currentFileContent = null;
        let currentFileLastModified = null;
        
        // Yetkilendirme deÄŸiÅŸkenleri
        const ADMIN_EMAIL = 'huseyin.kilic@karincalogistics.com';
        let currentUserEmail = null;
        let isAuthenticated = false;
        let isAdmin = false;
        
        // Mola saatleri verisi
        const defaultShiftSchedule = {
            'Fiba': {
                vardiyaBaslangic: '08:00',
                ilkMola: '09:45',
                yemekMolasi: '11:45', 
                ikinciMola: '15:15',
                vardiyaBitis: '17:30',
                mesaiBaslangic: '17:30',
                mesaiYemek: '17:30',
                mesaiMola: '19:45',
                mesaiBitis: '21:00'
            },
            'Derimod': {
                vardiyaBaslangic: '08:00',
                ilkMola: '10:15',
                yemekMolasi: '13:00',
                ikinciMola: '15:30', 
                vardiyaBitis: '17:30',
                mesaiBaslangic: '17:30',
                mesaiYemek: '17:30',
                mesaiMola: '19:45',
                mesaiBitis: '21:00'
            },
            'PanÃ§o': {
                vardiyaBaslangic: '08:00',
                ilkMola: '10:30',
                yemekMolasi: '12:45',
                ikinciMola: '15:30',
                vardiyaBitis: '17:30', 
                mesaiBaslangic: '17:30',
                mesaiYemek: '17:30',
                mesaiMola: '19:45',
                mesaiBitis: '21:00'
            }
        };

        // Bu fonksiyon zaten yukarÄ±da gÃ¼ncellendi, kaldÄ±rÄ±labilir

        // File upload baÅŸlatma
        function initializeFileUpload() {
            const fileInput = document.getElementById('file-input');
            const uploadArea = document.getElementById('upload-area');
            
            // File input change event
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    processFile(file);
                }
            });
            
            // Drag & drop events
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });
        }

        // Dosya iÅŸleme
        async function processFile(file) {
            try {
                console.log('Dosya iÅŸleniyor:', file.name);
                showLoading();
                
                // Dosya boyutu kontrolÃ¼
                if (file.size === 0) {
                    throw new Error('Dosya boÅŸ gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen dosyayÄ± kaydedin ve tekrar deneyin.');
                }
                
                // Dosya bilgilerini sakla
                currentFileName = file.name;
                currentFileLastModified = file.lastModified;
                
                // Dosya okuma
                const data = await readFile(file);
                console.log('Dosya okundu:', data.length, 'satÄ±r');
                
                // Dosya iÃ§eriÄŸini sakla (yedek iÃ§in)
                currentFileContent = data;
                
                // Veri iÅŸleme
                const processedData = processData(data);
                console.log('Veri iÅŸlendi:', processedData);
                
                // Dashboard gÃ¼ncelleme
                updateDashboard(processedData);
                
                hideLoading();
                
            } catch (error) {
                console.error('Hata:', error);
                hideLoading();
                throw error; // Hata'yÄ± yukarÄ± fÄ±rlat (alert gÃ¶sterme)
            }
        }

        // Dosya okuma
        function readFile(file) {
            return new Promise((resolve, reject) => {
                // Dosya kontrolÃ¼
                if (!file) {
                    reject(new Error('Dosya seÃ§ilmedi'));
                    return;
                }
                
                if (file.size === 0) {
                    reject(new Error('Dosya boÅŸ. LÃ¼tfen Excel dosyasÄ±nÄ± kaydedin ve kapatÄ±n.'));
                    return;
                }
                
                const reader = new FileReader();
                
                // Timeout ekle (5 saniye)
                const timeout = setTimeout(() => {
                    reader.abort();
                    reject(new Error('Dosya okuma zaman aÅŸÄ±mÄ±. Excel dosyasÄ±nÄ± kapatÄ±p tekrar deneyin.'));
                }, 5000);
                
                reader.onload = function(e) {
                    clearTimeout(timeout);
                    try {
                        if (file.name.toLowerCase().endsWith('.csv')) {
                            // CSV okuma
                            const text = e.target.result;
                            if (!text || text.trim() === '') {
                                reject(new Error('CSV dosyasÄ± boÅŸ'));
                                return;
                            }
                            const lines = text.split('\n').filter(line => line.trim());
                            const data = lines.map(line => line.split(',').map(cell => cell.trim()));
                            resolve(data);
                        } else {
                            // Excel okuma
                            const data = new Uint8Array(e.target.result);
                            if (data.length === 0) {
                                reject(new Error('Excel dosyasÄ± boÅŸ veya bozuk'));
                                return;
                            }
                            
                            const workbook = XLSX.read(data, { 
                                type: 'array',
                                cellDates: false, // Tarihleri sayÄ± olarak al
                                cellNF: false,
                                cellText: false
                            });
                            
                            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                                reject(new Error('Excel dosyasÄ±nda sayfa bulunamadÄ±'));
                                return;
                            }
                            
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            
                            if (!jsonData || jsonData.length === 0) {
                                reject(new Error('Excel dosyasÄ±nda veri bulunamadÄ±'));
                                return;
                            }
                            
                            resolve(jsonData);
                        }
                    } catch (error) {
                        clearTimeout(timeout);
                        console.error('Dosya parse hatasÄ±:', error);
                        reject(new Error('Dosya formatÄ± hatalÄ±: ' + error.message));
                    }
                };
                
                reader.onerror = function(e) {
                    clearTimeout(timeout);
                    console.error('FileReader hatasÄ±:', e);
                    reject(new Error('Dosya okuma hatasÄ±. Excel dosyasÄ±nÄ± kapatÄ±p tekrar deneyin.'));
                };
                
                reader.onabort = function() {
                    clearTimeout(timeout);
                    reject(new Error('Dosya okuma iptal edildi'));
                };
                
                // Dosya okumaya baÅŸla
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        reader.readAsText(file, 'UTF-8');
                    } else {
                        reader.readAsArrayBuffer(file);
                    }
                } catch (error) {
                    clearTimeout(timeout);
                    reject(new Error('Dosya okuma baÅŸlatÄ±lamadÄ±: ' + error.message));
                }
            });
        }

        // Veri iÅŸleme
        function processData(rawData) {
            if (!rawData || rawData.length < 2) {
                throw new Error('GeÃ§ersiz veri');
            }
            
            const headers = rawData[0];
            const rows = rawData.slice(1);
            
            console.log('Headers:', headers);
            console.log('Rows:', rows.length);
            
            // Kolon indekslerini bul
            const personelIndex = findColumnIndex(headers, ['personel', 'personnel', 'ad', 'name']);
            const miktarIndex = findColumnIndex(headers, ['miktar', 'quantity', 'amount']);
            const projeIndex = findColumnIndex(headers, ['proje', 'project', 'depo', 'warehouse']);
            const tarihIndex = findColumnIndex(headers, ['tarih', 'date', 'iÅŸlem tarihi']);
            const saatIndex = findColumnIndex(headers, ['saat', 'time', 'iÅŸlem saati']);
            const hareketIndex = findColumnIndex(headers, ['hareket', 'movement', 'hareket tipi']);
            const skuIndex = findColumnIndex(headers, ['sku', 'sku kodu', 'sku_kodu']);
            
            console.log('Kolon indeksleri:', { personelIndex, miktarIndex, projeIndex, tarihIndex, saatIndex, hareketIndex, skuIndex });
            
            // Personel verilerini iÅŸle
            const personnelMap = {};
            const warehouseSet = new Set();
            const movementTypeSet = new Set();
            let totalQuantity = 0;
            
            rows.forEach((row, index) => {
                if (row.length === 0) return;
                
                const personel = personelIndex >= 0 ? row[personelIndex] : '';
                const miktar = miktarIndex >= 0 ? parseFloat(row[miktarIndex]) || 0 : 0;
                const proje = projeIndex >= 0 ? row[projeIndex] : '';
                const tarih = tarihIndex >= 0 ? row[tarihIndex] : '';
                const saat = saatIndex >= 0 ? row[saatIndex] : '';
                const hareket = hareketIndex >= 0 ? row[hareketIndex] : '';
                const sku = skuIndex >= 0 ? row[skuIndex] : '';
                
                if (personel) {
                    if (!personnelMap[personel]) {
                        personnelMap[personel] = {
                            name: personel,
                            totalTransactions: 0,
                            totalQuantity: 0,
                            transactions: [],
                            warehouses: new Set(),
                            movementTypes: new Set(),
                            performance: 0
                        };
                    }
                    
                    // Ä°ÅŸlem detayÄ±nÄ± ekle
                    const transaction = {
                        id: index,
                        date: formatDate(tarih),
                        time: formatTime(saat),
                        warehouse: proje,
                        movementType: hareket,
                        sku: sku,
                        quantity: miktar
                    };
                    
                    personnelMap[personel].transactions.push(transaction);
                    personnelMap[personel].totalTransactions++;
                    personnelMap[personel].totalQuantity += miktar;
                    
                    // Debug: Ä°ÅŸlem sayÄ±sÄ±nÄ± logla
                    if (personnelMap[personel].totalTransactions % 100 === 0) {
                        console.log(`ğŸ“Š ${personel}: ${personnelMap[personel].totalTransactions} iÅŸlem`);
                    }
                    
                    if (proje) personnelMap[personel].warehouses.add(proje);
                    if (hareket) personnelMap[personel].movementTypes.add(hareket);
                }
                
                if (proje) warehouseSet.add(proje);
                if (hareket) movementTypeSet.add(hareket);
                totalQuantity += miktar;
            });
            
            // Personel performansÄ±nÄ± hesapla
            const personnel = Object.values(personnelMap).map(person => {
                person.warehouses = Array.from(person.warehouses);
                person.movementTypes = Array.from(person.movementTypes);
                person.performance = Math.min(100, Math.round((person.totalQuantity / 100) + (person.totalTransactions * 5)));
                
                // GerÃ§ek Ã§alÄ±ÅŸma saatleri hesapla (Excel'deki iÅŸlem saatlerinden)
                const workingHours = calculateRealWorkingHours(person);
                person.workingHours = workingHours;
                
                return person;
            });
            
            const warehouses = Array.from(warehouseSet);
            const movementTypes = Array.from(movementTypeSet);
            
            return {
                personnel: personnel,
                warehouses: warehouses,
                movementTypes: movementTypes,
                totalTransactions: rows.length,
                totalQuantity: totalQuantity,
                rawData: rows,
                headers: headers
            };
        }

        // Kolon indeksi bulma
        function findColumnIndex(headers, possibleNames) {
            for (let i = 0; i < headers.length; i++) {
                const header = headers[i].toLowerCase().trim();
                for (let name of possibleNames) {
                    if (header.includes(name.toLowerCase())) {
                        return i;
                    }
                }
            }
            return -1;
        }

        // Dashboard gÃ¼ncelleme
        function updateDashboard(data) {
            appData = data;
            
            // Upload section gizle
            document.getElementById('upload-section').style.display = 'none';
            // Dashboard gÃ¶ster
            document.getElementById('dashboard-content').style.display = 'block';
            
            // KPI'larÄ± gÃ¼ncelle
            document.getElementById('total-personnel').textContent = data.personnel.length;
            document.getElementById('total-transactions').textContent = data.totalTransactions;
            document.getElementById('total-quantity').textContent = data.totalQuantity.toLocaleString();
            document.getElementById('active-warehouses').textContent = data.warehouses.length;
            
            // Toplam net Ã§alÄ±ÅŸma saati hesapla
            const totalNetMinutes = data.personnel.reduce((sum, person) => sum + (person.workingHours?.netHours || 0), 0);
            document.getElementById('working-hours').textContent = minutesToTime(totalNetMinutes);
            
            console.log('âœ… Dashboard gÃ¼ncellendi:', data.personnel.length, 'personel yÃ¼klendi');
        }
        
        // Tarih formatla
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            
            // String'e Ã§evir
            const dateString = String(dateStr).trim();
            if (!dateString || dateString === '') return '-';
            
            // EÄŸer Excel sayÄ±sal tarih formatÄ±ysa (45966 gibi), bugÃ¼nÃ¼n tarihini gÃ¶ster
            if (!isNaN(dateString) && dateString.length >= 4) {
                const excelDate = parseFloat(dateString);
                if (excelDate > 1000 && excelDate < 100000) {
                    // BugÃ¼nÃ¼n tarihini dÃ¶ndÃ¼r
                    const today = new Date();
                    const day = String(today.getDate()).padStart(2, '0');
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const year = today.getFullYear();
                    return `${day}.${month}.${year}`;
                }
            }
            
            // TÃ¼rkÃ§e tarih formatÄ±nÄ± kontrol et (01.12.2024)
            if (dateString.includes('.')) {
                const parts = dateString.split('.');
                if (parts.length === 3) {
                    const day = String(parts[0]).padStart(2, '0');
                    const month = String(parts[1]).padStart(2, '0');
                    const year = String(parts[2]);
                    return `${day}.${month}.${year}`;
                }
            }
            
            // ISO tarih formatÄ±nÄ± kontrol et (2024-12-01)
            if (dateString.includes('-') && dateString.length >= 8) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = String(parts[1]).padStart(2, '0');
                    const day = String(parts[2]).padStart(2, '0');
                    return `${day}.${month}.${year}`;
                }
            }
            
            // EÄŸer tarih formatÄ± tanÄ±nmÄ±yorsa, JavaScript Date ile parse etmeyi dene
            try {
                const parsedDate = new Date(dateString);
                if (!isNaN(parsedDate.getTime()) && parsedDate.getFullYear() > 1900 && parsedDate.getFullYear() < 2100) {
                    const day = String(parsedDate.getDate()).padStart(2, '0');
                    const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
                    const year = parsedDate.getFullYear();
                    return `${day}.${month}.${year}`;
                }
            } catch (e) {
                // Parse edilemezse orijinal deÄŸeri dÃ¶ndÃ¼r
            }
            
            return dateString;
        }
        
        // Saat formatla
        function formatTime(timeStr) {
            if (!timeStr) return '-';
            
            // Excel decimal formatÄ±nÄ± kontrol et (0.375 = 09:00)
            if (typeof timeStr === 'number' || (!isNaN(parseFloat(timeStr)) && String(timeStr).includes('.'))) {
                const decimal = parseFloat(timeStr);
                const totalMinutes = Math.round(decimal * 24 * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
            }
            
            // String'e Ã§evir
            const timeString = String(timeStr).trim();
            if (!timeString || timeString === '') return '-';
            
            // Saat formatÄ±nÄ± kontrol et (09:00)
            if (timeString.includes(':')) {
                const parts = timeString.split(':');
                if (parts.length >= 2) {
                    const hour = String(parts[0]).padStart(2, '0');
                    const minute = String(parts[1]).padStart(2, '0');
                    return `${hour}:${minute}`;
                }
            }
            
            // Sadece saat varsa (9)
            if (!isNaN(timeString) && timeString !== '') {
                return `${String(timeString).padStart(2, '0')}:00`;
            }
            
            return timeString;
        }
        
        // Saat farkÄ± hesapla (dakika cinsinden)
        function calculateTimeDifference(startTime, endTime) {
            if (!startTime || !endTime) return 0;
            
            const start = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);
            
            return end > start ? end - start : 0;
        }
        
        // Saat:dakika formatÄ±nÄ± dakikaya Ã§evir
        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            
            // Excel decimal formatÄ±nÄ± kontrol et (0.375 = 09:00)
            if (typeof timeStr === 'number' || (!isNaN(parseFloat(timeStr)) && timeStr.toString().includes('.'))) {
                const decimal = parseFloat(timeStr);
                const totalMinutes = Math.round(decimal * 24 * 60); // 24 saat * 60 dakika
                return totalMinutes;
            }
            
            // Normal saat:dakika formatÄ±
            const timeString = String(timeStr).trim();
            if (timeString.includes(':')) {
                const parts = timeString.split(':');
                if (parts.length >= 2) {
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    return hours * 60 + minutes;
                }
            }
            
            return 0;
        }
        
        // DakikayÄ± saat:dakika formatÄ±na Ã§evir
        function minutesToTime(minutes) {
            if (!minutes || minutes <= 0) return '0:00';
            
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            return `${hours}:${mins.toString().padStart(2, '0')}`;
        }
        
        // Personel iÃ§in gerÃ§ek Ã§alÄ±ÅŸma saati hesapla (Excel'deki iÅŸlem saatlerinden)
        function calculateRealWorkingHours(person) {
            console.log('ğŸ” Ã‡alÄ±ÅŸma saati hesaplanÄ±yor:', person.name, person.transactions?.length || 0, 'iÅŸlem');
            
            if (!person.transactions || person.transactions.length === 0) {
                console.log('âŒ Ä°ÅŸlem verisi yok:', person.name);
                return { netHours: 0, totalHours: 0, breakHours: 0, efficiency: 0, firstTransaction: null, lastTransaction: null, workingPeriod: 'Veri yok' };
            }
            
            // Ä°ÅŸlem saatlerini sÄ±rala
            const validTransactions = person.transactions.filter(t => t.time && t.time !== '-');
            console.log('âœ… GeÃ§erli iÅŸlemler:', person.name, validTransactions.length, 'adet');
            
            if (validTransactions.length === 0) {
                console.log('âŒ GeÃ§erli saat verisi yok:', person.name);
                return { netHours: 0, totalHours: 0, breakHours: 0, efficiency: 0, firstTransaction: null, lastTransaction: null, workingPeriod: 'Saat verisi yok' };
            }
            
            // Saatleri dakikaya Ã§evir ve sÄ±rala
            const transactionMinutes = validTransactions.map(t => {
                const minutes = timeToMinutes(t.time);
                const formattedTime = formatTime(t.time);
                return {
                    ...t,
                    minutes: minutes,
                    formattedTime: formattedTime
                };
            }).filter(t => t.minutes > 0).sort((a, b) => a.minutes - b.minutes);
            
            if (transactionMinutes.length === 0) {
                console.log('âŒ Ã‡evrilebilir saat verisi yok:', person.name);
                return { netHours: 0, totalHours: 0, breakHours: 0, efficiency: 0, firstTransaction: null, lastTransaction: null, workingPeriod: 'GeÃ§ersiz saat' };
            }
            
            const firstTransaction = transactionMinutes[0];
            const lastTransaction = transactionMinutes[transactionMinutes.length - 1];
            
            console.log(`ğŸ“… ${person.name} Ã§alÄ±ÅŸma saatleri: ${firstTransaction.formattedTime} - ${lastTransaction.formattedTime}`);
            
            // Ä°lk ve son iÅŸlem arasÄ±ndaki toplam sÃ¼re
            const totalWorkingMinutes = lastTransaction.minutes - firstTransaction.minutes;
            
            // Mola sÃ¼relerini hesapla (iÅŸlem yapÄ±lmayan boÅŸluklar)
            let breakMinutes = 0;
            const breakThreshold = 30; // 30 dakikadan fazla boÅŸluk = mola
            
            for (let i = 1; i < transactionMinutes.length; i++) {
                const gap = transactionMinutes[i].minutes - transactionMinutes[i-1].minutes;
                if (gap > breakThreshold) {
                    breakMinutes += gap;
                    console.log(`â˜• ${person.name} mola: ${transactionMinutes[i-1].formattedTime} - ${transactionMinutes[i].formattedTime} (${gap} dk)`);
                }
            }
            
            // Net Ã§alÄ±ÅŸma sÃ¼resi = Toplam sÃ¼re - Molalar
            const netWorkingMinutes = Math.max(0, totalWorkingMinutes - breakMinutes);
            
            // Verimlilik hesapla (iÅŸlem/saat) - BASIT HESAPLAMA
            const workingHours = netWorkingMinutes / 60;
            
            // EÄŸer net Ã§alÄ±ÅŸma 1 saatten az ise, saatlik iÅŸlem sayÄ±sÄ±nÄ± farklÄ± hesapla
            let efficiency = 0;
            if (workingHours > 0) {
                if (workingHours < 1) {
                    // 1 saatten az Ã§alÄ±ÅŸma iÃ§in: iÅŸlem sayÄ±sÄ±nÄ± saate oranla
                    efficiency = (person.totalTransactions / workingHours).toFixed(1);
                } else {
                    // Normal hesaplama
                    efficiency = (person.totalTransactions / workingHours).toFixed(1);
                }
            }
            
            console.log(`ğŸ” DEBUG ${person.name}:`);
            console.log(`  - Ä°ÅŸlem sayÄ±sÄ±: ${person.totalTransactions}`);
            console.log(`  - Net Ã§alÄ±ÅŸma dakika: ${netWorkingMinutes}`);
            console.log(`  - Net Ã§alÄ±ÅŸma saat: ${workingHours.toFixed(2)}`);
            console.log(`  - Hesaplama: ${person.totalTransactions} / ${workingHours.toFixed(2)} = ${efficiency}`);
            
            // Makul verimlilik aralÄ±ÄŸÄ±na sÄ±nÄ±rla (0-20 iÅŸlem/saat)
            const rawEfficiency = parseFloat(efficiency);
            if (rawEfficiency > 20) {
                console.log(`âš ï¸ UYARI: ${person.name} iÃ§in Ã§ok yÃ¼ksek verimlilik: ${rawEfficiency}`);
                // Makul bir deÄŸer hesapla: iÅŸlem sayÄ±sÄ±nÄ± saate bÃ¶l ama maksimum 20
                efficiency = Math.min(20, (person.totalTransactions / Math.max(workingHours, 1))).toFixed(1);
                console.log(`ğŸ”§ DÃœZELTME: ${efficiency} iÅŸlem/saat olarak ayarlandÄ±`);
            } else if (rawEfficiency < 0.1 && person.totalTransactions > 0) {
                // Ã‡ok dÃ¼ÅŸÃ¼k verimlilik de dÃ¼zelt
                efficiency = (person.totalTransactions / Math.max(workingHours, 0.5)).toFixed(1);
                console.log(`ğŸ”§ DÃœÅÃœK VERÄ°MLÄ°LÄ°K DÃœZELTME: ${efficiency} iÅŸlem/saat`);
            }
            
            console.log(`âœ… ${person.name} sonuÃ§: Net ${netWorkingMinutes}dk, Mola ${breakMinutes}dk, Verimlilik ${efficiency}`);
            
            return {
                netHours: netWorkingMinutes,
                totalHours: totalWorkingMinutes,
                breakHours: breakMinutes,
                efficiency: parseFloat(efficiency),
                firstTransaction: firstTransaction.formattedTime,
                lastTransaction: lastTransaction.formattedTime,
                workingPeriod: `${firstTransaction.formattedTime} - ${lastTransaction.formattedTime}`
            };
        }
        
        // Personel listesini gÃ¶ster
        function showPersonnelList() {
            if (!appData || !appData.personnel) {
                alert('Personel verisi bulunamadÄ±!');
                return;
            }
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ‘¥</span>
                        </div>
                        <div>
                            <h2>Personel Listesi</h2>
                            <p>${appData.personnel.length} Aktif Personel</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="personnel-grid-modal">
                        ${appData.personnel.map(person => {
                            const performanceClass = getPerformanceClass(person.performance);
                            return `
                                <div class="personnel-card-modal" onclick="showPersonnelDetailsByName('${person.name}')">
                                    <div class="personnel-header">
                                        <div class="personnel-avatar">
                                            <span>${person.name.charAt(0).toUpperCase()}</span>
                                        </div>
                                        <div class="personnel-info">
                                            <h4>${person.name}</h4>
                                            <span class="personnel-role">Operasyon Personeli</span>
                                        </div>
                                        <div class="personnel-performance ${performanceClass}">
                                            <span class="performance-score">${person.performance}%</span>
                                            <span class="performance-label">Performans</span>
                                        </div>
                                    </div>
                                    
                                    <div class="personnel-stats">
                                        <div class="stat-item">
                                            <span class="stat-icon">ğŸ“¦</span>
                                            <div class="stat-content">
                                                <span class="stat-value">${person.totalTransactions}</span>
                                                <span class="stat-label">Ä°ÅŸlem</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">ğŸ”´</span>
                                            <div class="stat-content">
                                                <span class="stat-value">${person.totalQuantity.toLocaleString()}</span>
                                                <span class="stat-label">Miktar</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">ğŸ¢</span>
                                            <div class="stat-content">
                                                <span class="stat-value">${person.warehouses.length}</span>
                                                <span class="stat-label">Proje</span>
                                            </div>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-icon">â°</span>
                                            <div class="stat-content">
                                                <span class="stat-value">${minutesToTime(person.workingHours?.netHours || 0)}</span>
                                                <span class="stat-label">Ã‡alÄ±ÅŸma</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="personnel-footer">
                                        <button class="btn-detail" onclick="event.stopPropagation(); showPersonnelDetailsByName('${person.name}')">
                                            DetaylarÄ± GÃ¶rÃ¼ntÃ¼le
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // Miktar detaylarÄ±nÄ± gÃ¶ster
        function showQuantityDetails() {
            if (!appData) return;
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ“Š</span>
                        </div>
                        <div>
                            <h2>Miktar DetaylarÄ±</h2>
                            <p>Toplam ${appData.totalQuantity.toLocaleString()} Birim</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ“Š</span>
                            <div>
                                <span class="detail-value">${appData.totalQuantity.toLocaleString()}</span>
                                <span class="detail-label">Toplam Miktar</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">âš¡</span>
                            <div>
                                <span class="detail-value">${Math.round(appData.totalQuantity / appData.totalTransactions).toLocaleString()}</span>
                                <span class="detail-label">Ortalama/Ä°ÅŸlem</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ‘¥</span>
                            <div>
                                <span class="detail-value">${Math.round(appData.totalQuantity / appData.personnel.length).toLocaleString()}</span>
                                <span class="detail-label">Ortalama/Personel</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Personel BazÄ±nda Miktar DaÄŸÄ±lÄ±mÄ±</h3>
                        <div class="quantity-list">
                            ${appData.personnel.sort((a, b) => b.totalQuantity - a.totalQuantity).map(person => `
                                <div class="quantity-item">
                                    <div class="quantity-person">
                                        <div class="personnel-avatar small">
                                            <span>${person.name.charAt(0).toUpperCase()}</span>
                                        </div>
                                        <span>${person.name}</span>
                                    </div>
                                    <div class="quantity-bar">
                                        <div class="quantity-fill" style="width: ${(person.totalQuantity / Math.max(...appData.personnel.map(p => p.totalQuantity))) * 100}%"></div>
                                        <span class="quantity-value">${person.totalQuantity.toLocaleString()}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // Proje detaylarÄ±nÄ± gÃ¶ster
        function showWarehouseDetails() {
            if (!appData) return;
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ¢</span>
                        </div>
                        <div>
                            <h2>Proje DetaylarÄ±</h2>
                            <p>${appData.warehouses.length} Aktif Proje</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-section">
                        <h3>Aktif Projeler</h3>
                        <div class="warehouse-grid">
                            ${appData.warehouses.map(warehouse => {
                                const warehousePersonnel = appData.personnel.filter(p => p.warehouses.includes(warehouse));
                                const warehouseQuantity = warehousePersonnel.reduce((sum, p) => sum + p.totalQuantity, 0);
                                return `
                                    <div class="warehouse-card">
                                        <div class="warehouse-header">
                                            <span class="warehouse-icon">ğŸ¢</span>
                                            <h4>${warehouse}</h4>
                                        </div>
                                        <div class="warehouse-stats">
                                            <div class="warehouse-stat">
                                                <span>ğŸ‘¥ ${warehousePersonnel.length} Personel</span>
                                            </div>
                                            <div class="warehouse-stat">
                                                <span>ğŸ“Š ${warehouseQuantity.toLocaleString()} Miktar</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // Ä°ÅŸlem detaylarÄ±nÄ± gÃ¶ster
        function showTransactionDetails() {
            if (!appData) return;
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ“¦</span>
                        </div>
                        <div>
                            <h2>Ä°ÅŸlem DetaylarÄ±</h2>
                            <p>Toplam ${appData.totalTransactions.toLocaleString()} Ä°ÅŸlem</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ“¦</span>
                            <div>
                                <span class="detail-value">${appData.totalTransactions.toLocaleString()}</span>
                                <span class="detail-label">Toplam Ä°ÅŸlem</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ‘¥</span>
                            <div>
                                <span class="detail-value">${Math.round(appData.totalTransactions / appData.personnel.length)}</span>
                                <span class="detail-label">Ortalama/Personel</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ¢</span>
                            <div>
                                <span class="detail-value">${Math.round(appData.totalTransactions / appData.warehouses.length)}</span>
                                <span class="detail-label">Ortalama/Proje</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Hareket Tipleri</h3>
                        <div class="tag-list">
                            ${appData.movementTypes.map(type => `<span class="tag movement-tag">${type}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        // Personel listesi gÃ¼ncelleme (artÄ±k kullanÄ±lmÄ±yor - KPI kartlarÄ± Ã¼zerinden eriÅŸiliyor)
        function updatePersonnelList(personnel) {
            // Bu fonksiyon artÄ±k kullanÄ±lmÄ±yor
            // Personel listesi KPI kartlarÄ± Ã¼zerinden modal olarak gÃ¶steriliyor
            console.log('Personel listesi hazÄ±r:', personnel.length, 'personel');
        }
        
        // Performans sÄ±nÄ±fÄ± belirleme
        function getPerformanceClass(performance) {
            if (performance >= 80) return 'excellent';
            if (performance >= 60) return 'good';
            if (performance >= 40) return 'average';
            return 'poor';
        }
        
        // Hareket tipi sÄ±nÄ±fÄ± belirleme
        function getMovementClass(movementType) {
            if (!movementType) return 'default';
            const type = movementType.toLowerCase();
            if (type.includes('giriÅŸ') || type.includes('giris')) return 'entry';
            if (type.includes('Ã§Ä±kÄ±ÅŸ') || type.includes('cikis')) return 'exit';
            if (type.includes('transfer')) return 'transfer';
            if (type.includes('sayÄ±m') || type.includes('sayim')) return 'count';
            return 'default';
        }
        
        // Personel detaylarÄ±nÄ± isimle gÃ¶ster
        function showPersonnelDetailsByName(personName) {
            if (!appData || !appData.personnel) {
                alert('Personel verisi bulunamadÄ±!');
                return;
            }
            
            const person = appData.personnel.find(p => p.name === personName);
            if (!person) {
                alert('Personel bulunamadÄ±: ' + personName);
                return;
            }
            
            showPersonnelDetails(person);
        }
        
        // Personel detaylarÄ±nÄ± gÃ¶ster
        function showPersonnelDetails(person) {
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>${person.name.charAt(0).toUpperCase()}</span>
                        </div>
                        <div>
                            <h2>${person.name}</h2>
                            <p>Operasyon Personeli</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ“¦</span>
                            <div>
                                <span class="detail-value">${person.totalTransactions}</span>
                                <span class="detail-label">Toplam Ä°ÅŸlem</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ“Š</span>
                            <div>
                                <span class="detail-value">${person.totalQuantity}</span>
                                <span class="detail-label">Toplam Miktar</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ¯</span>
                            <div>
                                <span class="detail-value">${person.performance}%</span>
                                <span class="detail-label">Performans</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">â°</span>
                            <div>
                                <span class="detail-value">${minutesToTime(person.workingHours?.netHours || 0)}</span>
                                <span class="detail-label">Net Ã‡alÄ±ÅŸma</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">âš¡</span>
                            <div>
                                <span class="detail-value">${person.workingHours?.efficiency || 0}</span>
                                <span class="detail-label">Ä°ÅŸlem/Saat</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Ã‡alÄ±ÅŸtÄ±ÄŸÄ± Projeler</h3>
                        <div class="tag-list">
                            ${person.warehouses.map(w => `<span class="tag warehouse-tag">${w}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Hareket Tipleri</h3>
                        <div class="tag-list">
                            ${person.movementTypes.map(m => `<span class="tag movement-tag">${m}</span>`).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Ã‡alÄ±ÅŸma Saatleri</h3>
                        <div class="working-time-info">
                            <div class="time-info-item">
                                <span class="time-label">Ã‡alÄ±ÅŸma Saatleri:</span>
                                <span class="time-value">${person.workingHours?.workingPeriod || 'Veri yok'}</span>
                            </div>
                            <div class="time-info-item">
                                <span class="time-label">Net Ã‡alÄ±ÅŸma:</span>
                                <span class="time-value">${minutesToTime(person.workingHours?.netHours || 0)}</span>
                            </div>
                            <div class="time-info-item">
                                <span class="time-label">Mola SÃ¼resi:</span>
                                <span class="time-value">${minutesToTime(person.workingHours?.breakHours || 0)}</span>
                            </div>
                            <div class="time-info-item">
                                <span class="time-label">Verimlilik:</span>
                                <span class="time-value">${person.workingHours?.efficiency || 0} iÅŸlem/saat</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>TÃ¼m Ä°ÅŸlem GeÃ§miÅŸi (${person.transactions.length} Ä°ÅŸlem)</h3>
                        <div class="transactions-summary">
                            <div class="summary-item">
                                <span class="summary-label">Ä°lk Ä°ÅŸlem:</span>
                                <span class="summary-value">${person.workingHours?.firstTransaction || '-'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Son Ä°ÅŸlem:</span>
                                <span class="summary-value">${person.workingHours?.lastTransaction || '-'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Toplam Miktar:</span>
                                <span class="summary-value">${person.totalQuantity.toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="transactions-table-container">
                            <div class="transactions-table">
                                <div class="table-header">
                                    <span>SÄ±ra</span>
                                    <span>Tarih</span>
                                    <span>Saat</span>
                                    <span>Hareket Tipi</span>
                                    <span>Proje</span>
                                    <span>SKU Kodu</span>
                                    <span>Miktar</span>
                                </div>
                                ${person.transactions.map((t, index) => `
                                    <div class="table-row ${index % 2 === 0 ? 'even' : 'odd'}">
                                        <span class="row-number">${index + 1}</span>
                                        <span class="transaction-date">${t.date || '-'}</span>
                                        <span class="transaction-time">${formatTime(t.time) || '-'}</span>
                                        <span class="movement-type">
                                            <span class="movement-badge ${getMovementClass(t.movementType)}">${t.movementType || '-'}</span>
                                        </span>
                                        <span class="warehouse-name">${t.warehouse || '-'}</span>
                                        <span class="sku-code">${t.sku || '-'}</span>
                                        <span class="quantity-amount">${t.quantity ? t.quantity.toLocaleString() : '-'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="transactions-stats">
                            <div class="stat-group">
                                <h4>Hareket Tipi DaÄŸÄ±lÄ±mÄ±</h4>
                                <div class="movement-stats">
                                    ${(() => {
                                        const movementCounts = {};
                                        person.transactions.forEach(t => {
                                            if (t.movementType) {
                                                movementCounts[t.movementType] = (movementCounts[t.movementType] || 0) + 1;
                                            }
                                        });
                                        return Object.entries(movementCounts).map(([type, count]) => `
                                            <div class="movement-stat-item">
                                                <span class="movement-badge ${getMovementClass(type)}">${type}</span>
                                                <span class="movement-count">${count} adet</span>
                                            </div>
                                        `).join('');
                                    })()}
                                </div>
                            </div>
                            
                            <div class="stat-group">
                                <h4>Saatlik DaÄŸÄ±lÄ±m</h4>
                                <div class="hourly-stats">
                                    ${(() => {
                                        const hourCounts = {};
                                        person.transactions.forEach(t => {
                                            if (t.time) {
                                                const hour = formatTime(t.time).split(':')[0];
                                                hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                                            }
                                        });
                                        return Object.entries(hourCounts).sort().map(([hour, count]) => `
                                            <div class="hour-stat-item">
                                                <span class="hour-label">${hour}:00</span>
                                                <div class="hour-bar">
                                                    <div class="hour-fill" style="width: ${(count / Math.max(...Object.values(hourCounts))) * 100}%"></div>
                                                    <span class="hour-count">${count}</span>
                                                </div>
                                            </div>
                                        `).join('');
                                    })()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // Ã‡alÄ±ÅŸma saatleri detaylarÄ±nÄ± gÃ¶ster
        function showWorkingHours() {
            if (!appData) return;
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>â°</span>
                        </div>
                        <div>
                            <h2>Ã‡alÄ±ÅŸma Saatleri Analizi</h2>
                            <p>Personel bazÄ±nda net Ã§alÄ±ÅŸma sÃ¼releri</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <span class="detail-icon">â°</span>
                            <div>
                                <span class="detail-value">${minutesToTime(appData.personnel.reduce((sum, p) => sum + (p.workingHours?.netHours || 0), 0))}</span>
                                <span class="detail-label">Toplam Net Ã‡alÄ±ÅŸma</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">â˜•</span>
                            <div>
                                <span class="detail-value">${minutesToTime(appData.personnel.reduce((sum, p) => sum + (p.workingHours?.breakHours || 0), 0))}</span>
                                <span class="detail-label">Toplam Mola</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">ğŸ“Š</span>
                            <div>
                                <span class="detail-value">${(() => {
                                    const totalNetHours = appData.personnel.reduce((sum, p) => sum + (p.workingHours?.netHours || 0), 0) / 60;
                                    return totalNetHours > 0 ? (appData.totalTransactions / totalNetHours).toFixed(1) : 0;
                                })()}</span>
                                <span class="detail-label">Ä°ÅŸlem/Saat</span>
                            </div>
                        </div>
                        <div class="detail-stat">
                            <span class="detail-icon">âš¡</span>
                            <div>
                                <span class="detail-value">${(() => {
                                    const validPersonnel = appData.personnel.filter(p => p.workingHours?.efficiency > 0);
                                    const avgEfficiency = validPersonnel.length > 0 ? 
                                        validPersonnel.reduce((sum, p) => sum + parseFloat(p.workingHours.efficiency), 0) / validPersonnel.length : 0;
                                    return avgEfficiency.toFixed(1);
                                })()}</span>
                                <span class="detail-label">Ort. Ä°ÅŸlem/Saat</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Proje BazÄ±nda Mola Saatleri</h3>
                        <div class="shift-schedule-grid">
                            ${Object.entries(defaultShiftSchedule).map(([project, schedule]) => `
                                <div class="shift-card">
                                    <div class="shift-header">
                                        <h4>${project}</h4>
                                    </div>
                                    <div class="shift-timeline">
                                        <div class="timeline-item work">
                                            <span class="timeline-time">${schedule.vardiyaBaslangic}</span>
                                            <span class="timeline-label">Vardiya BaÅŸlangÄ±Ã§</span>
                                        </div>
                                        <div class="timeline-item break">
                                            <span class="timeline-time">${schedule.ilkMola}</span>
                                            <span class="timeline-label">Ä°lk Mola</span>
                                        </div>
                                        <div class="timeline-item break">
                                            <span class="timeline-time">${schedule.yemekMolasi}</span>
                                            <span class="timeline-label">Yemek MolasÄ±</span>
                                        </div>
                                        <div class="timeline-item break">
                                            <span class="timeline-time">${schedule.ikinciMola}</span>
                                            <span class="timeline-label">Ä°kinci Mola</span>
                                        </div>
                                        <div class="timeline-item work">
                                            <span class="timeline-time">${schedule.vardiyaBitis}</span>
                                            <span class="timeline-label">Vardiya BitiÅŸ</span>
                                        </div>
                                        <div class="timeline-item overtime">
                                            <span class="timeline-time">${schedule.mesaiBaslangic}</span>
                                            <span class="timeline-label">Mesai BaÅŸlangÄ±Ã§</span>
                                        </div>
                                        <div class="timeline-item break">
                                            <span class="timeline-time">${schedule.mesaiMola}</span>
                                            <span class="timeline-label">Mesai Mola</span>
                                        </div>
                                        <div class="timeline-item overtime">
                                            <span class="timeline-time">${schedule.mesaiBitis}</span>
                                            <span class="timeline-label">Mesai BitiÅŸ</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Personel BazÄ±nda GerÃ§ek Ã‡alÄ±ÅŸma Analizi</h3>
                        <div class="working-hours-table">
                            <div class="table-header">
                                <span>Personel</span>
                                <span>Ã‡alÄ±ÅŸma Saatleri</span>
                                <span>Net Ã‡alÄ±ÅŸma</span>
                                <span>Mola SÃ¼resi</span>
                                <span>Ä°ÅŸlem/Saat</span>
                                <span>Verimlilik</span>
                            </div>
                            ${appData.personnel.map(person => `
                                <div class="table-row">
                                    <span>
                                        <div class="personnel-avatar small">
                                            <span>${person.name.charAt(0).toUpperCase()}</span>
                                        </div>
                                        ${person.name}
                                    </span>
                                    <span class="working-period">
                                        ${person.workingHours?.workingPeriod || 'Veri yok'}
                                    </span>
                                    <span class="net-hours">
                                        ${minutesToTime(person.workingHours?.netHours || 0)}
                                    </span>
                                    <span class="break-hours">
                                        ${minutesToTime(person.workingHours?.breakHours || 0)}
                                    </span>
                                    <span class="efficiency">
                                        ${person.workingHours?.efficiency || 0}
                                    </span>
                                    <span>
                                        <div class="performance-badge ${getPerformanceClass(person.performance)}">
                                            ${person.performance}%
                                        </div>
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
        
        // Modal oluÅŸtur ve gÃ¶ster
        function showModal(content) {
            // Eski modal varsa kaldÄ±r
            const existingModal = document.getElementById('personnel-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Modal wrapper oluÅŸtur
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'personnel-modal';
            
            // Modal container oluÅŸtur
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal-container';
            modalContainer.innerHTML = content;
            
            modal.appendChild(modalContainer);
            document.body.appendChild(modal);
        }
        
        // Modal kapat
        function closeModal() {
            const modal = document.getElementById('personnel-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapat
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Loading gÃ¶sterme/gizleme
        function showLoading() {
            document.getElementById('upload-progress').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('upload-progress').style.display = 'none';
        }

        // Debug toggle
        function toggleDebug() {
            console.log('Debug bilgileri:', appData);
            if (appData) {
                alert('Personel: ' + appData.personnel.length + 
                      '\nÄ°ÅŸlem: ' + appData.totalTransactions + 
                      '\nMiktar: ' + appData.totalQuantity + 
                      '\nProje: ' + appData.warehouses.length);
            }
        }

        // Menu toggle
        function toggleMenu() {
            const menu = document.getElementById('dropdown-menu');
            const menuBtn = document.getElementById('menu-btn');
            
            menu.classList.toggle('show');
            menuBtn.classList.toggle('active');
        }

        // Mevcut sekmede dosya seÃ§
        function selectFileCurrentTab() {
            const fileInput = document.getElementById('file-input');
            fileInput.click();
            
            // MenÃ¼yÃ¼ kapat
            closeMenu();
            
            showToast('ğŸ“ LÃ¼tfen Excel dosyasÄ±nÄ± seÃ§in', 'info');
        }

        // Yeni sekmede aÃ§
        function openNewTab() {
            // Yeni sekme aÃ§
            const newWindow = window.open(window.location.href, '_blank');
            
            // MenÃ¼yÃ¼ kapat
            closeMenu();
            
            showToast('ğŸš€ Yeni sekmede dashboard aÃ§Ä±ldÄ±', 'info');
        }

        // MenÃ¼yÃ¼ kapat (yardÄ±mcÄ± fonksiyon)
        function closeMenu() {
            const menu = document.getElementById('dropdown-menu');
            const menuBtn = document.getElementById('menu-btn');
            menu.classList.remove('show');
            menuBtn.classList.remove('active');
        }

        // Ayarlar menÃ¼sÃ¼ toggle
        function toggleSettings() {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsBtn = document.getElementById('settings-btn');
            
            settingsMenu.classList.toggle('show');
            settingsBtn.classList.toggle('active');
            
            // DiÄŸer menÃ¼leri kapat
            closeMenu();
        }

        // Tema deÄŸiÅŸtir
        function setTheme(theme) {
            // Tema'yÄ± localStorage'a kaydet
            localStorage.setItem('dashboard-theme', theme);
            
            // Tema'yÄ± uygula
            applyTheme(theme);
            
            // Ayarlar menÃ¼sÃ¼nÃ¼ kapat
            closeSettings();
            
            // Toast mesajÄ± gÃ¶ster
            const themeNames = {
                'light': 'AydÄ±nlÄ±k',
                'dark': 'KaranlÄ±k', 
                'auto': 'Otomatik'
            };
            showToast(`ğŸ¨ ${themeNames[theme]} tema aktif edildi`, 'info');
        }

        // Tema uygula
        function applyTheme(theme) {
            const body = document.body;
            
            // Mevcut tema sÄ±nÄ±flarÄ±nÄ± temizle
            body.classList.remove('theme-light', 'theme-dark', 'theme-auto');
            
            // Yeni tema sÄ±nÄ±fÄ±nÄ± ekle
            body.classList.add(`theme-${theme}`);
            
            // Otomatik tema iÃ§in sistem tercihini kontrol et
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                body.classList.add(prefersDark ? 'theme-dark' : 'theme-light');
            }
            
            // Aktif tema gÃ¶stergesini gÃ¼ncelle
            updateThemeIndicators(theme);
        }

        // Tema gÃ¶stergelerini gÃ¼ncelle
        function updateThemeIndicators(activeTheme) {
            const indicators = ['light-indicator', 'dark-indicator', 'auto-indicator'];
            
            indicators.forEach(id => {
                const indicator = document.getElementById(id);
                if (indicator) {
                    indicator.classList.remove('active');
                }
            });
            
            const activeIndicator = document.getElementById(`${activeTheme}-indicator`);
            if (activeIndicator) {
                activeIndicator.classList.add('active');
            }
        }

        // Ayarlar menÃ¼sÃ¼nÃ¼ kapat
        function closeSettings() {
            const settingsMenu = document.getElementById('settings-menu');
            const settingsBtn = document.getElementById('settings-btn');
            settingsMenu.classList.remove('show');
            settingsBtn.classList.remove('active');
        }

        // ============================================
        // YETKÄ°LENDÄ°RME SÄ°STEMÄ°
        // ============================================

        // Yetkili email listesini getir (Firebase'den)
        async function getAuthorizedEmails() {
            return await FirebaseAuth.getAuthorizedEmails();
        }

        // Admin email listesini getir (Firebase'den)
        async function getAdminEmails() {
            return await FirebaseAuth.getAdminEmails();
        }

        // Email validasyonu
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // GiriÅŸ kontrolÃ¼
        async function checkAccess() {
            const savedEmail = localStorage.getItem('dashboard-current-user');
            
            if (!savedEmail) {
                showLoginScreen();
                return false;
            }

            const isAuthorized = await FirebaseAuth.checkUserAuthorization(savedEmail);
            
            if (isAuthorized) {
                const adminEmails = await getAdminEmails();
                currentUserEmail = savedEmail;
                isAuthenticated = true;
                isAdmin = adminEmails.includes(savedEmail);
                showDashboard();
                updateMenuVisibility();
                return true;
            } else {
                showLoginScreen();
                return false;
            }
        }

        // Login ekranÄ±nÄ± gÃ¶ster
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-header').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'none';
            
            setTimeout(() => {
                const emailInput = document.getElementById('login-email-input');
                if (emailInput) {
                    emailInput.focus();
                    emailInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            performLogin();
                        }
                    });
                }
            }, 100);
        }

        // Dashboard'Ä± gÃ¶ster
        function showDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-header').style.display = 'block';
            document.getElementById('main-dashboard').style.display = 'block';
        }

        // GiriÅŸ yap
        async function performLogin() {
            const emailInput = document.getElementById('login-email-input');
            const passwordInput = document.getElementById('login-password-input');
            const email = emailInput.value.trim().toLowerCase();
            const password = passwordInput.value;
            
            if (!email) {
                showToast('âŒ LÃ¼tfen email adresinizi girin', 'error');
                return;
            }
            
            if (!password) {
                showToast('âŒ LÃ¼tfen ÅŸifrenizi girin', 'error');
                return;
            }
            
            if (!FirebaseAuth.isValidEmail(email)) {
                showToast('âŒ GeÃ§erli bir email adresi girin', 'error');
                return;
            }
            
            showToast('ğŸ”„ GiriÅŸ yapÄ±lÄ±yor...', 'info');
            
            try {
                // Firebase Authentication ile giriÅŸ yap
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Yetki kontrolÃ¼ yap
                const isAuthorized = await FirebaseAuth.checkUserAuthorization(email);
                
                if (isAuthorized) {
                    const adminEmails = await getAdminEmails();
                    
                    localStorage.setItem('dashboard-current-user', email);
                    currentUserEmail = email;
                    isAuthenticated = true;
                    isAdmin = adminEmails.includes(email);
                    
                    showDashboard();
                    updateMenuVisibility();
                    
                    if (isAdmin) {
                        showToast('ğŸ‘‘ Anahtar KullanÄ±cÄ± olarak giriÅŸ yapÄ±ldÄ±!', 'success');
                    } else {
                        showToast('âœ… BaÅŸarÄ±yla giriÅŸ yapÄ±ldÄ±!', 'success');
                    }
                } else {
                    // Yetkisi yoksa Ã§Ä±kÄ±ÅŸ yap
                    await firebase.auth().signOut();
                    showToast('âŒ Bu email adresi yetkili deÄŸil!', 'error');
                }
            } catch (error) {
                console.error('GiriÅŸ hatasÄ±:', error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast('âŒ HatalÄ± ÅŸifre!', 'error');
                } else if (error.code === 'auth/user-not-found') {
                    showToast('âŒ KullanÄ±cÄ± bulunamadÄ±! LÃ¼tfen admin ile iletiÅŸime geÃ§in.', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showToast('âŒ Ã‡ok fazla baÅŸarÄ±sÄ±z deneme. LÃ¼tfen daha sonra tekrar deneyin.', 'error');
                } else {
                    showToast('âŒ GiriÅŸ yapÄ±lamadÄ±: ' + error.message, 'error');
                }
            }
        }

        // MenÃ¼ gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ gÃ¼ncelle
        function updateMenuVisibility() {
            const adminMenuItem = document.getElementById('admin-menu-item');
            if (adminMenuItem) {
                adminMenuItem.style.display = isAdmin ? 'flex' : 'none';
            }
        }

        // KullanÄ±cÄ± bilgisini gÃ¶ster
        function showUserInfo() {
            const userType = isAdmin ? 'Anahtar KullanÄ±cÄ±' : 'Normal KullanÄ±cÄ±';
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>${isAdmin ? 'ğŸ‘‘' : 'ğŸ‘¤'}</span>
                        </div>
                        <div>
                            <h2>KullanÄ±cÄ± Bilgisi</h2>
                            <p>${userType}</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="user-info-card">
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${currentUserEmail}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Yetki Seviyesi:</span>
                                <span class="info-value">${userType}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Durum:</span>
                                <span class="info-value">âœ… Aktif</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            closeSettings();
        }

        // Åifre yÃ¶netimi panelini gÃ¶ster
        function showPasswordManagement() {
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ”‘</span>
                        </div>
                        <div>
                            <h2>Åifre YÃ¶netimi</h2>
                            <p>Åifrenizi gÃ¼venli bir ÅŸekilde deÄŸiÅŸtirin</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-section">
                        <div class="password-change-form">
                            <div class="form-group">
                                <label for="current-password">Mevcut Åifre</label>
                                <input type="password" id="current-password" class="form-input" placeholder="Mevcut ÅŸifrenizi girin" />
                            </div>
                            <div class="form-group">
                                <label for="new-password">Yeni Åifre</label>
                                <input type="password" id="new-password" class="form-input" placeholder="Yeni ÅŸifrenizi girin (en az 6 karakter)" />
                            </div>
                            <div class="form-group">
                                <label for="confirm-password">Yeni Åifre (Tekrar)</label>
                                <input type="password" id="confirm-password" class="form-input" placeholder="Yeni ÅŸifrenizi tekrar girin" />
                            </div>
                            <div class="form-actions" style="margin-top: 1.5rem;">
                                <button class="btn btn-primary" onclick="changePassword()" style="width: 100%;">
                                    ğŸ”‘ Åifreyi DeÄŸiÅŸtir
                                </button>
                            </div>
                            <div class="password-info" style="margin-top: 1.5rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    <strong>ğŸ’¡ Ä°pucu:</strong> GÃ¼Ã§lÃ¼ bir ÅŸifre iÃ§in en az 6 karakter kullanÄ±n ve bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf, rakam ve Ã¶zel karakterler ekleyin.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            closeSettings();
        }

        // Åifre deÄŸiÅŸtir
        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('âŒ LÃ¼tfen tÃ¼m alanlarÄ± doldurun', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('âŒ Yeni ÅŸifre en az 6 karakter olmalÄ±dÄ±r', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('âŒ Yeni ÅŸifreler eÅŸleÅŸmiyor', 'error');
                return;
            }
            
            showToast('ğŸ”„ Åifre deÄŸiÅŸtiriliyor...', 'info');
            
            try {
                const user = firebase.auth().currentUser;
                
                if (!user) {
                    showToast('âŒ Oturum bulunamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.', 'error');
                    return;
                }
                
                // Ã–nce mevcut ÅŸifre ile yeniden kimlik doÄŸrulama yap
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );
                
                await user.reauthenticateWithCredential(credential);
                
                // Åifreyi deÄŸiÅŸtir
                await user.updatePassword(newPassword);
                
                // Modal'Ä± kapat
                closeModal();
                
                // BaÅŸarÄ± mesajÄ±nÄ± modal kapandÄ±ktan sonra gÃ¶ster
                setTimeout(() => {
                    showToast('âœ… Åifreniz baÅŸarÄ±yla deÄŸiÅŸtirildi!', 'success');
                }, 100);
                
            } catch (error) {
                console.error('Åifre deÄŸiÅŸtirme hatasÄ±:', error);
                
                if (error.code === 'auth/wrong-password') {
                    showToast('âŒ Mevcut ÅŸifre hatalÄ±!', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showToast('âŒ Åifre Ã§ok zayÄ±f! Daha gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in.', 'error');
                } else if (error.code === 'auth/requires-recent-login') {
                    showToast('âŒ GÃ¼venlik nedeniyle tekrar giriÅŸ yapmanÄ±z gerekiyor', 'error');
                    setTimeout(() => logout(), 2000);
                } else {
                    showToast('âŒ Åifre deÄŸiÅŸtirilemedi: ' + error.message, 'error');
                }
            }
        }

        // Admin panelini gÃ¶ster
        async function showAdminPanel() {
            if (!isAdmin) {
                showToast('âŒ Bu Ã¶zellik sadece anahtar kullanÄ±cÄ± iÃ§in!', 'error');
                return;
            }
            
            showToast('ğŸ”„ KullanÄ±cÄ± listesi yÃ¼kleniyor...', 'info');
            
            const authorizedEmails = await getAuthorizedEmails();
            const adminEmails = await getAdminEmails();
            
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ‘‘</span>
                        </div>
                        <div>
                            <h2>Yetkilendirme Paneli</h2>
                            <p>KullanÄ±cÄ± yetkilendirme yÃ¶netimi</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="admin-panel">
                        <div class="add-user-section">
                            <h3>ğŸ‘‘ Anahtar KullanÄ±cÄ± Ekle</h3>
                            <div class="form-group">
                                <input type="email" id="new-admin-input" class="form-input" placeholder="anahtar.kullanici@email.com" />
                                <button class="btn btn-primary" onclick="addNewAdmin()">
                                    ğŸ‘‘ Anahtar KullanÄ±cÄ± Yap
                                </button>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.5rem; display: block;">
                                âš ï¸ Anahtar kullanÄ±cÄ±lar yetkilendirme paneline eriÅŸebilir ve diÄŸer kullanÄ±cÄ±larÄ± yÃ¶netebilir.
                            </small>
                        </div>
                        
                        <div class="add-user-section">
                            <h3>ğŸ‘¤ Normal KullanÄ±cÄ± Ekle</h3>
                            <div class="form-group">
                                <input type="email" id="new-user-input" class="form-input" placeholder="kullanici@email.com" />
                                <button class="btn btn-secondary" onclick="addNewUser()">
                                    â• Yetki Ver
                                </button>
                            </div>
                        </div>
                        
                        <div class="users-section">
                            <h3>ğŸ‘‘ Anahtar KullanÄ±cÄ±lar (${adminEmails.length})</h3>
                            <div class="users-list">
                                ${adminEmails.map((email, index) => `
                                    <div class="user-list-item" onclick="toggleUserActions('admin-${index}')">
                                        <div class="user-list-main">
                                            <span class="user-list-icon">ğŸ‘‘</span>
                                            <div class="user-list-info">
                                                <div class="user-list-email">${email}</div>
                                                <div class="user-list-role">${email === ADMIN_EMAIL ? 'Ana Anahtar' : 'Anahtar'}</div>
                                            </div>
                                            <span class="user-list-arrow">â–¼</span>
                                        </div>
                                        <div class="user-list-actions" id="admin-${index}" style="display: none;">
                                            <button class="action-btn action-btn-reset" onclick="event.stopPropagation(); sendPasswordResetEmail('${email}')">
                                                ğŸ”‘ Åifre SÄ±fÄ±rlama Email'i GÃ¶nder
                                            </button>
                                            ${email !== ADMIN_EMAIL ? `
                                                <button class="action-btn action-btn-delete" onclick="event.stopPropagation(); removeAdmin('${email}')">
                                                    ğŸ—‘ï¸ Anahtar Yetkisini KaldÄ±r
                                                </button>
                                            ` : '<div class="action-protected">ğŸ”’ Bu kullanÄ±cÄ± korumalÄ±dÄ±r</div>'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="users-section">
                            <h3>ğŸ‘¤ Normal KullanÄ±cÄ±lar (${authorizedEmails.length})</h3>
                            <div class="users-list">
                                ${authorizedEmails.length === 0 ? 
                                    '<div class="no-users">HenÃ¼z normal kullanÄ±cÄ± eklenmemiÅŸ</div>' :
                                    authorizedEmails.map((email, index) => `
                                        <div class="user-list-item" onclick="toggleUserActions('user-${index}')">
                                            <div class="user-list-main">
                                                <span class="user-list-icon">ğŸ‘¤</span>
                                                <div class="user-list-info">
                                                    <div class="user-list-email">${email}</div>
                                                    <div class="user-list-role">Normal KullanÄ±cÄ±</div>
                                                </div>
                                                <span class="user-list-arrow">â–¼</span>
                                            </div>
                                            <div class="user-list-actions" id="user-${index}" style="display: none;">
                                                <button class="action-btn action-btn-reset" onclick="event.stopPropagation(); sendPasswordResetEmail('${email}')">
                                                    ğŸ”‘ Åifre SÄ±fÄ±rlama Email'i GÃ¶nder
                                                </button>
                                                <button class="action-btn action-btn-delete" onclick="event.stopPropagation(); removeUser('${email}')">
                                                    ğŸ—‘ï¸ Yetkiyi KaldÄ±r
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                        
                        <div class="danger-zone-section">
                            <h3>âš ï¸ Tehlikeli BÃ¶lge</h3>
                            <div class="danger-zone-content">
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                                    VeritabanÄ±nÄ± sÄ±fÄ±rlamak TÃœM kullanÄ±cÄ± yetkilerini silecektir. Bu iÅŸlem geri alÄ±namaz!
                                </p>
                                <button class="btn btn-danger" onclick="resetDatabase()" style="background: #dc3545;">
                                    ğŸ—‘ï¸ VeritabanÄ±nÄ± SÄ±fÄ±rla
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
            closeSettings();
        }

        // Yeni admin ekle
        async function addNewAdmin() {
            const adminInput = document.getElementById('new-admin-input');
            const email = adminInput.value.trim().toLowerCase();
            
            if (!email) {
                showToast('âŒ LÃ¼tfen email adresi girin', 'error');
                return;
            }
            
            if (!FirebaseAuth.isValidEmail(email)) {
                showToast('âŒ GeÃ§erli bir email adresi girin', 'error');
                return;
            }
            
            if (email === ADMIN_EMAIL) {
                showToast('âš ï¸ Bu email zaten ana anahtar kullanÄ±cÄ±', 'warning');
                return;
            }
            
            const adminEmails = await getAdminEmails();
            if (adminEmails.includes(email)) {
                showToast('âš ï¸ Bu kullanÄ±cÄ± zaten anahtar kullanÄ±cÄ±', 'warning');
                return;
            }
            
            if (confirm(`"${email}" kullanÄ±cÄ±sÄ±nÄ± anahtar kullanÄ±cÄ± yapmak istediÄŸinizden emin misiniz?`)) {
                showToast('ğŸ”„ Ekleniyor...', 'info');
                
                const success = await FirebaseAuth.addAdminEmail(email);
                
                if (success) {
                    adminInput.value = '';
                    showToast('ğŸ‘‘ Anahtar kullanÄ±cÄ± yetkisi verildi', 'success');
                    setTimeout(() => showAdminPanel(), 500);
                } else {
                    showToast('âŒ Bir hata oluÅŸtu', 'error');
                }
            }
        }

        // Yeni normal kullanÄ±cÄ± ekle
        async function addNewUser() {
            const userInput = document.getElementById('new-user-input');
            const email = userInput.value.trim().toLowerCase();
            
            if (!email) {
                showToast('âŒ LÃ¼tfen email adresi girin', 'error');
                return;
            }
            
            if (!FirebaseAuth.isValidEmail(email)) {
                showToast('âŒ GeÃ§erli bir email adresi girin', 'error');
                return;
            }
            
            if (email === ADMIN_EMAIL) {
                showToast('âš ï¸ Bu email zaten ana anahtar kullanÄ±cÄ±', 'warning');
                return;
            }
            
            const adminEmails = await getAdminEmails();
            if (adminEmails.includes(email)) {
                showToast('âš ï¸ Bu kullanÄ±cÄ± zaten anahtar kullanÄ±cÄ±', 'warning');
                return;
            }
            
            const authorizedEmails = await getAuthorizedEmails();
            if (authorizedEmails.includes(email)) {
                showToast('âš ï¸ Bu kullanÄ±cÄ± zaten yetkili', 'warning');
                return;
            }
            
            showToast('ğŸ”„ Ekleniyor...', 'info');
            
            const success = await FirebaseAuth.addAuthorizedEmail(email);
            
            if (success) {
                userInput.value = '';
                showToast('âœ… Normal kullanÄ±cÄ± yetkisi verildi', 'success');
                setTimeout(() => showAdminPanel(), 500);
            } else {
                showToast('âŒ Bir hata oluÅŸtu', 'error');
            }
        }

        // Admin yetkisini kaldÄ±r
        async function removeAdmin(email) {
            if (email === ADMIN_EMAIL) return;
            
            if (confirm(`"${email}" kullanÄ±cÄ±sÄ±nÄ±n anahtar kullanÄ±cÄ± yetkisini kaldÄ±rmak istediÄŸinizden emin misiniz?`)) {
                showToast('ğŸ”„ KaldÄ±rÄ±lÄ±yor...', 'info');
                
                const success = await FirebaseAuth.removeAdminEmail(email);
                
                if (success) {
                    // Normal kullanÄ±cÄ± olarak ekle
                    await FirebaseAuth.addAuthorizedEmail(email);
                    
                    showToast('ğŸ‘‘ Anahtar kullanÄ±cÄ± yetkisi kaldÄ±rÄ±ldÄ±', 'success');
                    setTimeout(() => showAdminPanel(), 500);
                } else {
                    showToast('âŒ Bir hata oluÅŸtu', 'error');
                }
            }
        }

        // KullanÄ±cÄ± aksiyonlarÄ±nÄ± aÃ§/kapat
        function toggleUserActions(id) {
            const element = document.getElementById(id);
            const arrow = element.previousElementSibling.querySelector('.user-list-arrow');
            
            if (element.style.display === 'none') {
                element.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            } else {
                element.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // Åifre sÄ±fÄ±rlama email'i gÃ¶nder
        async function sendPasswordResetEmail(email) {
            if (confirm(`"${email}" adresine ÅŸifre sÄ±fÄ±rlama email'i gÃ¶ndermek istediÄŸinizden emin misiniz?`)) {
                showToast('ğŸ”„ Email gÃ¶nderiliyor...', 'info');
                
                try {
                    await firebase.auth().sendPasswordResetEmail(email);
                    showToast(`âœ… Åifre sÄ±fÄ±rlama email'i "${email}" adresine gÃ¶nderildi!`, 'success');
                } catch (error) {
                    console.error('Åifre sÄ±fÄ±rlama email hatasÄ±:', error);
                    
                    if (error.code === 'auth/user-not-found') {
                        showToast('âŒ Bu email adresi ile kayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±!', 'error');
                    } else if (error.code === 'auth/invalid-email') {
                        showToast('âŒ GeÃ§ersiz email adresi!', 'error');
                    } else {
                        showToast('âŒ Email gÃ¶nderilemedi: ' + error.message, 'error');
                    }
                }
            }
        }

        // Normal kullanÄ±cÄ± yetkisini kaldÄ±r
        async function removeUser(email) {
            if (confirm(`"${email}" kullanÄ±cÄ±sÄ±nÄ±n yetkisini tamamen kaldÄ±rmak istediÄŸinizden emin misiniz?`)) {
                showToast('ğŸ”„ KaldÄ±rÄ±lÄ±yor...', 'info');
                
                const success = await FirebaseAuth.removeAuthorizedEmail(email);
                
                if (success) {
                    showToast('âœ… KullanÄ±cÄ± yetkisi kaldÄ±rÄ±ldÄ±', 'success');
                    setTimeout(() => showAdminPanel(), 500);
                } else {
                    showToast('âŒ Bir hata oluÅŸtu', 'error');
                }
            }
        }

        // VeritabanÄ±nÄ± sÄ±fÄ±rla
        async function resetDatabase() {
            const confirmation = prompt('âš ï¸ UYARI: Bu iÅŸlem TÃœM kullanÄ±cÄ± yetkilerini silecektir!\n\nDevam etmek iÃ§in "SIFIRLA" yazÄ±n:');
            
            if (confirmation !== 'SIFIRLA') {
                if (confirmation !== null) {
                    showToast('âŒ Ä°ÅŸlem iptal edildi', 'error');
                }
                return;
            }
            
            showToast('ğŸ”„ VeritabanÄ± sÄ±fÄ±rlanÄ±yor...', 'info');
            
            try {
                const response = await fetch('https://karinca-dashboard-bd8bd-default-rtdb.firebaseio.com/.json', {
                    method: 'PUT',
                    body: JSON.stringify({
                        authorizedEmails: [],
                        adminEmails: []
                    })
                });
                
                if (response.ok) {
                    showToast('âœ… VeritabanÄ± sÄ±fÄ±rlandÄ±! TÃ¼m yetkiler silindi.', 'success');
                    setTimeout(() => {
                        closeModal();
                        logout();
                    }, 2000);
                } else {
                    throw new Error('SÄ±fÄ±rlama baÅŸarÄ±sÄ±z');
                }
            } catch (error) {
                console.error('Reset hatasÄ±:', error);
                showToast('âŒ VeritabanÄ± sÄ±fÄ±rlanamadÄ±: ' + error.message, 'error');
            }
        }

        // Ã‡Ä±kÄ±ÅŸ yap
        async function logout() {
            if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
                try {
                    // Firebase'den Ã§Ä±kÄ±ÅŸ yap
                    await firebase.auth().signOut();
                } catch (error) {
                    console.error('Firebase Ã§Ä±kÄ±ÅŸ hatasÄ±:', error);
                }
                
                localStorage.removeItem('dashboard-current-user');
                currentUserEmail = null;
                isAuthenticated = false;
                isAdmin = false;
                appData = null;
                
                showLoginScreen();
                closeSettings();
                showToast('ğŸ‘‹ Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±', 'info');
            }
        }

        // ============================================
        // SAYFA BAÅLATMA
        // ============================================

        // Sayfa yÃ¼klendiÄŸinde
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Dashboard yÃ¼kleniyor...');
            
            // Firebase'i baÅŸlat
            console.log('ğŸ”¥ Firebase baÅŸlatÄ±lÄ±yor...');
            const firebaseInitialized = FirebaseAuth.initialize();
            
            if (firebaseInitialized) {
                console.log('âœ… Firebase baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');
                // Firebase deÄŸiÅŸikliklerini dinle
                FirebaseAuth.setupListeners();
            } else {
                console.warn('âš ï¸ Firebase baÅŸlatÄ±lamadÄ±, yerel mod kullanÄ±lacak');
            }
            
            // Tema'yÄ± yÃ¼kle
            const savedTheme = localStorage.getItem('dashboard-theme') || 'light';
            applyTheme(savedTheme);
            
            // File upload'Ä± baÅŸlat
            initializeFileUpload();
            
            // EriÅŸim kontrolÃ¼
            await checkAccess();
            
            console.log('âœ… Dashboard hazÄ±r');
        });

        // MenÃ¼ dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapat
        document.addEventListener('click', function(e) {
            const menuContainer = document.querySelector('.menu-container');
            const settingsContainer = document.querySelector('.settings-container');
            const menu = document.getElementById('dropdown-menu');
            const settingsMenu = document.getElementById('settings-menu');
            const menuBtn = document.getElementById('menu-btn');
            const settingsBtn = document.getElementById('settings-btn');
            
            if (!menuContainer.contains(e.target)) {
                menu.classList.remove('show');
                menuBtn.classList.remove('active');
            }
            
            if (!settingsContainer.contains(e.target)) {
                settingsMenu.classList.remove('show');
                settingsBtn.classList.remove('active');
            }
        });

        // Verileri yenile - AkÄ±llÄ± versiyon
        async function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const originalText = refreshBtn.innerHTML;
            
            // Butonu loading durumuna getir
            refreshBtn.innerHTML = '<span class="btn-icon spinning">ğŸ”„</span>Yenileniyor...';
            refreshBtn.disabled = true;
            
            try {
                // EÄŸer veri yÃ¼klÃ¼yse
                if (appData && currentFileName) {
                    console.log('ğŸ”„ Dosya yenileme iÅŸlemi baÅŸlatÄ±lÄ±yor:', currentFileName);
                    showToast('Veriler yenileniyor...', 'info');
                    
                    const fileInput = document.getElementById('file-input');
                    
                    // Ã–nce mevcut file input'u kontrol et
                    if (fileInput.files && fileInput.files[0]) {
                        const currentFile = fileInput.files[0];
                        
                        // Dosya adÄ± aynÄ± mÄ± kontrol et
                        if (currentFile.name === currentFileName) {
                            try {
                                // Dosya deÄŸiÅŸmiÅŸ mi kontrol et
                                if (currentFile.lastModified !== currentFileLastModified) {
                                    console.log('ğŸ“ Dosya deÄŸiÅŸikliÄŸi tespit edildi, yeniden yÃ¼kleniyor...');
                                    await processFile(currentFile);
                                    showToast('âœ… Veriler baÅŸarÄ±yla yenilendi!', 'success');
                                    return;
                                } else {
                                    // Dosya deÄŸiÅŸmemiÅŸ, yine de yeniden yÃ¼kle
                                    console.log('ğŸ”„ Dosya zorla yeniden yÃ¼kleniyor...');
                                    await processFile(currentFile);
                                    showToast('âœ… Veriler yenilendi!', 'success');
                                    return;
                                }
                            } catch (error) {
                                console.warn('Dosya yeniden yÃ¼klenemedi:', error.message);
                                // Hata durumunda devam et
                            }
                        }
                    }
                    
                    // File input Ã§alÄ±ÅŸmadÄ±ysa, kullanÄ±cÄ±ya yardÄ±mcÄ± mesaj gÃ¶ster
                    showRefreshHelp();
                    
                } else {
                    // Ä°lk kez yÃ¼kleme
                    console.log('ğŸ“ Ä°lk dosya yÃ¼klemesi');
                    showToast('ğŸ“ LÃ¼tfen Excel dosyasÄ±nÄ± seÃ§in', 'info');
                    const fileInput = document.getElementById('file-input');
                    fileInput.click();
                }
                
            } catch (error) {
                console.error('Refresh genel hatasÄ±:', error);
                showToast('âŒ Beklenmeyen hata oluÅŸtu!', 'error');
            } finally {
                // Butonu her durumda eski haline getir
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Yenileme yardÄ±m mesajÄ± gÃ¶ster
        function showRefreshHelp() {
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ”„</span>
                        </div>
                        <div>
                            <h2>Dosya Yenileme</h2>
                            <p>Excel dosyasÄ±nÄ± gÃ¼ncellemek iÃ§in</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-section">
                        <h3>ğŸ“‹ Kolay Yenileme YÃ¶ntemleri</h3>
                        <div class="refresh-methods">
                            <div class="method-card">
                                <div class="method-icon">ğŸ–±ï¸</div>
                                <div class="method-content">
                                    <h4>SÃ¼rÃ¼kle & BÄ±rak</h4>
                                    <p>Excel dosyasÄ±nÄ± kaydedip kapattÄ±ktan sonra, dosyayÄ± bu sayfaya sÃ¼rÃ¼kleyip bÄ±rakÄ±n</p>
                                </div>
                            </div>
                            <div class="method-card">
                                <div class="method-icon">ğŸ“</div>
                                <div class="method-content">
                                    <h4>Dosya SeÃ§</h4>
                                    <p>AÅŸaÄŸÄ±daki butona tÄ±klayarak gÃ¼ncellenmiÅŸ dosyayÄ± seÃ§in</p>
                                    <button class="btn btn-primary" onclick="closeModal(); document.getElementById('file-input').click();">
                                        ğŸ“ Dosya SeÃ§
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>ğŸ’¡ Ä°puÃ§larÄ±</h3>
                        <div class="tips-list">
                            <div class="tip-item">
                                <span class="tip-icon">âœ…</span>
                                <span>Excel'de deÄŸiÅŸiklik yaptÄ±ktan sonra <strong>Ctrl+S</strong> ile kaydedin</span>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">âœ…</span>
                                <span>Excel dosyasÄ±nÄ± <strong>tamamen kapatÄ±n</strong></span>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">âœ…</span>
                                <span>DosyayÄ± bu sayfaya <strong>sÃ¼rÃ¼kleyip bÄ±rakÄ±n</strong></span>
                            </div>
                            <div class="tip-item">
                                <span class="tip-icon">âš¡</span>
                                <span>BÃ¼yÃ¼k dosyalar iÃ§in <strong>CSV formatÄ±nda kaydetmeyi</strong> deneyin</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>ğŸ“Š Mevcut Dosya Bilgisi</h3>
                        <div class="current-file-info">
                            <div class="file-info-item">
                                <span class="info-label">Dosya AdÄ±:</span>
                                <span class="info-value">${currentFileName || 'Bilinmiyor'}</span>
                            </div>
                            <div class="file-info-item">
                                <span class="info-label">Personel SayÄ±sÄ±:</span>
                                <span class="info-value">${appData ? appData.personnel.length : 0}</span>
                            </div>
                            <div class="file-info-item">
                                <span class="info-label">Toplam Ä°ÅŸlem:</span>
                                <span class="info-value">${appData ? appData.totalTransactions.toLocaleString() : 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        // Toast notification gÃ¶ster
        function showToast(message, type = 'info') {
            // Mevcut toast'larÄ± temizle
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Yeni toast oluÅŸtur
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            // Toast'Ä± sayfaya ekle
            document.body.appendChild(toast);
            
            // Animasyon iÃ§in kÄ±sa bir gecikme
            setTimeout(() => {
                toast.classList.add('toast-show');
            }, 100);
            
            // 3 saniye sonra kaldÄ±r
            setTimeout(() => {
                toast.classList.remove('toast-show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Performans hesaplama bilgisini gÃ¶ster
        function showPerformanceInfo() {
            const modalContent = `
                <div class="modal-header">
                    <div class="modal-title">
                        <div class="personnel-avatar large">
                            <span>ğŸ“Š</span>
                        </div>
                        <div>
                            <h2>Performans Hesaplama Bilgisi</h2>
                            <p>Performans skorlarÄ± nasÄ±l hesaplanÄ±r?</p>
                        </div>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                
                <div class="modal-body">
                    <div class="detail-section">
                        <h3>Performans Skoru Kriterleri</h3>
                        <div class="performance-criteria">
                            <div class="criteria-item">
                                <div class="criteria-icon">ğŸ“Š</div>
                                <div class="criteria-content">
                                    <h4>Miktar BazlÄ±</h4>
                                    <p>Her 100 birim iÃ§in +1 puan</p>
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-icon">ğŸ“¦</div>
                                <div class="criteria-content">
                                    <h4>Ä°ÅŸlem BazlÄ±</h4>
                                    <p>Her iÅŸlem iÃ§in +5 puan</p>
                                </div>
                            </div>
                            <div class="criteria-item">
                                <div class="criteria-icon">ğŸ¯</div>
                                <div class="criteria-content">
                                    <h4>Maksimum SÄ±nÄ±r</h4>
                                    <p>100 puan ile sÄ±nÄ±rlÄ±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Performans Seviyeleri</h3>
                        <div class="performance-legend-modal">
                            <div class="legend-item-modal excellent">
                                <div class="legend-color-modal"></div>
                                <div class="legend-content">
                                    <h4>MÃ¼kemmel</h4>
                                    <p>80% ve Ã¼zeri</p>
                                </div>
                            </div>
                            <div class="legend-item-modal good">
                                <div class="legend-color-modal"></div>
                                <div class="legend-content">
                                    <h4>Ä°yi</h4>
                                    <p>60% - 79%</p>
                                </div>
                            </div>
                            <div class="legend-item-modal average">
                                <div class="legend-color-modal"></div>
                                <div class="legend-content">
                                    <h4>Orta</h4>
                                    <p>40% - 59%</p>
                                </div>
                            </div>
                            <div class="legend-item-modal poor">
                                <div class="legend-color-modal"></div>
                                <div class="legend-content">
                                    <h4>DÃ¼ÅŸÃ¼k</h4>
                                    <p>40% altÄ±</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Hesaplama Ã–rneÄŸi</h3>
                        <div class="calculation-example">
                            <div class="example-card">
                                <h4>Ã–rnek Personel</h4>
                                <div class="example-data">
                                    <div class="example-item">
                                        <span class="example-label">Toplam Miktar:</span>
                                        <span class="example-value">2,500 birim</span>
                                    </div>
                                    <div class="example-item">
                                        <span class="example-label">Toplam Ä°ÅŸlem:</span>
                                        <span class="example-value">150 iÅŸlem</span>
                                    </div>
                                </div>
                                <div class="calculation-steps">
                                    <div class="step">
                                        <span>Miktar PuanÄ±: 2,500 Ã· 100 = 25 puan</span>
                                    </div>
                                    <div class="step">
                                        <span>Ä°ÅŸlem PuanÄ±: 150 Ã— 5 = 750 puan</span>
                                    </div>
                                    <div class="step">
                                        <span>Toplam: 25 + 750 = 775 puan</span>
                                    </div>
                                    <div class="step final">
                                        <span>SonuÃ§: Min(775, 100) = <strong>100%</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }
    </script>
</body>
</html>
